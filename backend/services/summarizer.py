from __future__ import annotations

from typing import Any, Dict

from backend.llm.openai_compatible import OpenAICompatibleClient


EDITOR_PROMPT = """## è§’è‰²è®¾å®š
ä½ çŽ°åœ¨ä¸æ˜¯ä¸€ä¸ªç¨‹åºå‘˜ï¼Œä¹Ÿä¸è¦å†™ä»»ä½•ä»£ç ã€‚ä½ æ˜¯ä¸€ä½**èµ„æ·±ç§‘æŠ€ä¸»ç¼–**ï¼Œæ‹¥æœ‰æžå¼ºçš„é˜…è¯»ç†è§£èƒ½åŠ›å’Œæ•é”çš„è¡Œä¸šæ´žå¯ŸåŠ›ã€‚ä½ çš„å·¥ä½œæ˜¯äººå·¥å®¡é˜…æ¯ä¸€æ¡æŽ¨æ–‡ï¼ŒåŽ»ä¼ªå­˜çœŸã€‚

## æ ¸å¿ƒæŒ‡ä»¤ï¼ˆCRITICALï¼‰
1. **ä¸¥ç¦ä½¿ç”¨ä»£ç /Python**ï¼šä¸è¦è¯•å›¾å†™è„šæœ¬æ¥å¤„ç†æ•°æ®ã€‚æˆ‘éœ€è¦ä½ ç”¨ä½ çš„"å¤§è„‘"é€å­—é€å¥é˜…è¯»æ¯ä¸€æ¡å†…å®¹ã€‚
2. **æ·±åº¦è¯­ä¹‰åˆ†æž**ï¼šä¸è¦åªçœ‹å…³é”®è¯ã€‚ä¾‹å¦‚ï¼Œä¸è¦çœ‹åˆ° "AI" å°±è§‰å¾—æœ‰ä»·å€¼ï¼Œè¦çœ‹å®ƒå…·ä½“è¯´äº†ä»€ä¹ˆã€‚å¦‚æžœåªæ˜¯ç©ºæ´žçš„å£å·æˆ–æ— æ„ä¹‰çš„è½¬å‘ï¼Œå³ä½¿åŒ…å«å…³é”®è¯ä¹Ÿè§†ä¸º"æ— ä»·å€¼"ã€‚
3. **ä¸Šä¸‹æ–‡ç†è§£**ï¼šè¯†åˆ«æŽ¨æ–‡çš„çœŸå®žæ„å›¾ã€‚åŒºåˆ†"çœŸæ­£çš„æŠ€æœ¯åˆ†äº«"å’Œ"è¥é”€å¼•æµåºŸè¯"ã€‚

## å¤„ç†æµç¨‹
è¯·åœ¨å†…å¿ƒæŒ‰ä»¥ä¸‹æ­¥éª¤æ‰§è¡Œï¼ˆä¸è¦ç›´æŽ¥è¾“å‡ºè¿™ä¸ªè¿‡ç¨‹ï¼Œåªè¾“å‡ºæœ€ç»ˆç»“æžœï¼‰ï¼š
1. **é€æ¡é˜…è¯»**ï¼šæ·±è¯»æä¾›çš„æ¯ä¸€è¡Œå†…å®¹ã€‚
2. **äººå·¥åˆ¤åˆ«**ï¼šåŸºäºŽå†…å®¹è´¨é‡æ‰“åˆ†ï¼ˆ0-3æ˜Ÿï¼‰ã€‚
3. **å½’çº³æ€»ç»“**ï¼šåŸºäºŽé«˜åˆ†å†…å®¹è¿›è¡Œå†™ä½œã€‚

---

## è¾“å‡ºä»»åŠ¡

### ç¬¬ä¸€éƒ¨åˆ†ï¼šä»Šæ—¥è¦ç‚¹æ‘˜è¦ï¼ˆDeep Briefï¼‰
*è¯·ç»¼åˆæ‰€æœ‰ä¿¡æ¯ï¼Œå†™ä¸€æ®µ 100-200 å­—çš„æ·±åº¦ç»¼è¿°ã€‚*
- ä¸è¦è®°æµæ°´è´¦ï¼Œè¦å°†ç›¸å…³çš„ç‚¹ä¸²è”èµ·æ¥ã€‚
- å‘Šè¯‰æˆ‘ä»Šå¤©å¼€å‘è€…åœˆå­æœ€å…³æ³¨çš„ 3-5 ä»¶äº‹æ˜¯ä»€ä¹ˆã€‚

### ç¬¬äºŒéƒ¨åˆ†ï¼šç¼–è¾‘ç²¾é€‰ï¼ˆEditor's Choiceï¼‰
*ä»Žæ‰€æœ‰å†…å®¹ä¸­æŒ‘é€‰ 3-5 æ¡**ç»å¯¹ç²¾åŽ**ï¼ŒæŒ‰ä»¥ä¸‹åˆ†ç±»æ•´ç†ï¼ˆå¦‚æžœæ²¡æœ‰å¤Ÿæ ¼çš„å°±ç©ºç¼ºï¼‰ï¼š*

**ðŸ”§ ç¡¬æ ¸å·¥å…·**
- å·¥å…·å + è§£å†³äº†ä»€ä¹ˆç—›ç‚¹/ç‹¬ç‰¹åŠŸèƒ½ + [ID]

**ðŸ’¡ æ·±åº¦æ´žå¯Ÿ**
- è§‚ç‚¹ç²¾åŽï¼ˆç”¨ä½ çš„è¯é‡ç»„ï¼Œä¸è¦ç›´æŽ¥æ‘˜æŠ„ï¼‰ + [ID]

**ðŸ“° é‡å¤§åŠ¨æ€**
- äº‹ä»¶æœ¬èº« + å¯¹è¡Œä¸šçš„æ½œåœ¨å½±å“ + [ID]

**ðŸ“š ä¼˜è´¨èµ„æº**
- èµ„æºå†…å®¹ + ä¸ºä»€ä¹ˆå€¼å¾—å­¦ + [ID]

### ç¬¬ä¸‰éƒ¨åˆ†ï¼šé«˜ä»·å€¼æŽ¨æ–‡å®Œæ•´æ¸…å•
*åˆ—å‡ºæ‰€æœ‰è¯„çº§ä¸º 1æ˜ŸåŠä»¥ä¸Š çš„å†…å®¹ã€‚*

| æŽ¨èæŒ‡æ•° | ç±»åˆ« | å†…å®¹æç‚¼ï¼ˆäººè¯ç‰ˆï¼‰ | å…³é”®åŽŸæ–‡ç‰‡æ®µ | æŽ¨èç†ç”± | åŽŸæ–‡é“¾æŽ¥ |
|---|---|---|---|---|---|
| â­â­â­ | å·¥å…· | è§£å†³äº†Dockeré•œåƒè¿‡å¤§çš„é—®é¢˜ | "SlimToolkit reduce image size..." | æ˜¯ä¸€ä¸ªå¾ˆæœ‰ä»·å€¼çš„æ´žå¯Ÿ | [URL] |
| â­â­ | è§‚ç‚¹ | åé©³äº†LLMå¿…å®šäº§ç”Ÿæ„è¯†çš„è®ºç‚¹ | "Scaling laws won't lead to..." | å¾ˆæœ‰å“²ç†æ€§ | [URL] |

**æŽ¨èæŒ‡æ•°æ ‡å‡†ï¼š**
- â­â­â­ **å¿…è¯»**ï¼šæœ‰ä»£ç ã€æœ‰æ•°æ®ã€æœ‰ç‹¬ç‰¹è§è§£ã€æœ‰è½åœ°å·¥å…·ã€‚
- â­â­ **æŽ¨è**ï¼šæœ‰å…·ä½“ä¿¡æ¯é‡ï¼Œå€¼å¾—èŠ±æ—¶é—´çœ‹ä¸€çœ¼ã€‚
- â­ **å¯è¯»**ï¼šç¨å¾®æœ‰ç‚¹æ„æ€ï¼Œæˆ–è€…æ˜¯ä¸é”™çš„èµ„æºåˆ—è¡¨ã€‚

- æ€»ç»“ï¼šæœ¬æœŸå¤„ç†[xx]æ¡æŽ¨æ–‡ï¼Œç­›é€‰å‡º[xx]æ¡æœ‰ä»·å€¼çš„å†…å®¹
---

## ç­›é€‰ä¸Žè¿‡æ»¤æ ‡å‡†ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰

**âœ… å¿…é¡»ä¿ç•™ï¼ˆé«˜ä»·å€¼ä¿¡å·ï¼‰ï¼š**
- å…·ä½“çš„ GitHub ä»“åº“ã€Demo æ¼”ç¤ºã€Paper è§£è¯»ã€‚
- è§£å†³æŸä¸ªå…·ä½“ Bug æˆ–æŠ€æœ¯éš¾é¢˜çš„ç»éªŒåˆ†äº«ã€‚
- åŒ…å«æ•°æ®æ”¯æ’‘çš„è¡Œä¸šåˆ†æžï¼ˆè€Œéžæƒ…ç»ªè¾“å‡ºï¼‰ã€‚
- å…·ä½“çš„æ•™ç¨‹ã€Cheat Sheetã€å­¦ä¹ è·¯å¾„ã€‚

**âŒ å¿…é¡»ä¸¢å¼ƒï¼ˆå™ªéŸ³ï¼‰ï¼š**
- **æ‰€æœ‰**æ— å…³é—²èŠï¼ˆåƒé¥­ã€å¤©æ°”ã€æƒ…æ„Ÿã€å•çº¯çš„åæ§½ï¼‰ã€‚
- **æ‰€æœ‰**æ— æ„ä¹‰å›žå¤ï¼ˆ"Awesome", "Mark", "LFG", "å“ˆå“ˆ"ï¼‰ã€‚
- **æ‰€æœ‰**çº¯è¥é”€/ç©ºæŠ•/åŠ å¯†è´§å¸æŽ¨å¹¿ï¼ˆé™¤éžæ˜¯åŒºå—é“¾åº•å±‚æŠ€æœ¯è®¨è®ºï¼‰ã€‚
- **æ‰€æœ‰**çœ‹ä¸æ‡‚ä¸Šä¸‹æ–‡çš„ç¢Žç‰‡è¯­å¥ã€‚

---

## å¾…å¤„ç†æ•°æ®

"""


MAX_CSV_CHARS = 100000


def summarize_csv(
    app_cfg: Dict[str, Any],
    providers_cfg: Dict[str, Any],
    csv_text: str,
) -> str:
    claude_cfg = app_cfg.get("claude", {})
    provider_name = claude_cfg.get("provider", "claude")
    provider = providers_cfg["providers"][provider_name]

    client = OpenAICompatibleClient(
        provider_name=provider_name,
        base_url=provider["base_url"],
        api_key=provider.get("api_key"),
        default_headers=provider.get("headers", {}),
        max_retries=int(app_cfg.get("retry", {}).get("max_retries", 2)),
        timeout_s=float(claude_cfg.get("timeout_s", 120)),
    )

    if len(csv_text) > MAX_CSV_CHARS:
        csv_text = csv_text[:MAX_CSV_CHARS] + "\n\n[... å†…å®¹è¿‡é•¿ï¼Œå·²æˆªæ–­ ...]"

    custom_prompt = claude_cfg.get("editor_prompt", "").strip()
    prompt = custom_prompt if custom_prompt else EDITOR_PROMPT
    full_prompt = f"{prompt}\n\n{csv_text}"

    messages = [{"role": "user", "content": full_prompt}]
    resp = client.chat(
        messages,
        model=provider["model"],
        temperature=float(claude_cfg.get("temperature", 0.3)),
    )
    content = (
        (resp.get("choices") or [{}])[0].get("message", {}).get("content", "")
    )
    return content or ""
